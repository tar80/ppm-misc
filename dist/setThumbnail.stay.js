Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t){var r;if(null==this)throw new TypeError('Array.indexOf: "this" is null or not defined');var n=Object(this),a=n.length>>>0;if(0===a)return-1;var i=null!=t?t:0;if(Math.abs(i)===Infinity&&(i=0),i>=a)return-1;for(r=Math.max(i>=0?i:a-Math.abs(i),0);r<a;){if(r in n&&n[r]===e)return r;r++}return-1});var e,t=PPx.CreateObject("Scripting.FileSystemObject"),r={ppmName:"ppx-plugin-manager",ppmVersion:.95,language:"ja",encode:"utf16le",nlcode:"\r\n",nltype:"crlf",ppmID:"P",ppmSubID:"Q"},useLanguage=function(){var e=PPx.Extract("%*getcust(S_ppm#global:lang)");return"en"===e||"ja"===e?e:r.language},isEmptyStr=function(e){return""===e},n="folder.jpg",a="thumbcmd.txt",i="ppm-misc",s={en:{start:"Start thumbnail registration",noEntries:"no entries",viewstyle:"Please specify thumbnail viewstyle",abort:"aborting. no image mode",title:"Thumbnail generation command",halfway:"Discard StayMode",progress:"progress",completed:"completed"},ja:{start:"サムネイル登録を開始します",noEntries:"対象エントリがありません",viewstyle:"サムネイル形式を指定してください",abort:"中止。サムネイル表示ではありません",title:"サムネイル生成コマンド",halfway:"StayModeを破棄します",progress:"進捗",completed:"完了"}}[useLanguage()],u=PPx.Extract("%n"),x=PPx.Extract("%FD"),o=PPx.Extract("%*temp(misc_thumb,d)"),c=PPx.EntryMarkCount>0,P=PPx.Entry.AllEntry,l=0,p=0,main=function(){var t="'title':'"+s.title+"','mode':'e','leavecancel':true,'list':'on','module':'off','detail':'user1','file':'%sgu\"ppmcache\"\\list\\"+a+"'",r=PPx.Extract('%*script("%sgu\'ppmlib\'\\input.js","{'+t+'}")');("[error]"===r||/^\s*;/.test(r))&&(PPx.Execute("*delete "+o),PPx.Quit(-1)),(e=isEmptyStr(r)?setThumbnail:createThumbnail(r))()},ppx_Progress=function(){return e()},ppx_resume=function(){isOkey(s.halfway)&&(PPx.StayMode=0,setThumbnail(!0))},extract=function(e){return PPx.Extract("%*extract("+u+',"%('+e+'%)")')},linemessage=function(e){return PPx.Execute("*execute "+u+',*linemessage !"'+e)},isOkey=function(e){return 0===PPx.Execute('%"'+i+'"%Q"'+e+'"')},createThumbnail=function(e){PPx.StayMode=2;for(var t=PPx.StayMode,r=extractInputData(e),n=r[0],a=r[1],i=[];!P.atEnd();P.moveNext()){var f=P.Name;c&&0===P.Mark||(16&P.Attributes||!~n.indexOf(PPx.Extract('%*name(T,"'+f+'")'))||i.push(createCmdline(a,x+"\\"+f,o+"\\"+P.Index+".bmp")))}return l=i.length,P.Reset(),function(){linemessage(s.progress+" "+p+"/"+l),p++,i.length>0?PPx.Execute("*run -min -nostartmsg -noppb %0ppbw.exe -c "+i.shift()+"%%&*execute "+u+',*script ":'+t+',ppx_Progress"'):(PPx.StayMode=0,setThumbnail(l>0))}},setThumbnail=function(e){if(void 0===e&&(e=!1),e||0!==PPx.EntryDisplayDirectories){if(PPx.Extract("%n")!==u&&PPx.Execute("*focus "+u+"%:*wait 0,1"),isOkey(s.start)){for(x!==extract("%FD")&&PPx.Execute('%j"'+x+'"');!hasImageView();){if(!isOkey(s.viewstyle))return void PPx.Execute("*delete "+o);PPx.Execute("*viewstyle -temp")}for(var r=PPx.EntryIndex,n=getFolderThumbNames();!P.atEnd();P.moveNext())if(!c||0!==P.Mark)if(16&P.Attributes)for(var a=0;a<n.length;a++){var i=n[a],l=P.Name+"\\"+i;if(t.FileExists(l)){PPx.EntryIndex=P.Index,PPx.Execute("*setentryimage "+l+" -save");break}}else if(e){var p=P.Index,f=o+"\\"+p+".bmp";t.FileExists(f)&&(PPx.EntryIndex=p,PPx.Execute("*setentryimage "+f+" -save"))}PPx.EntryIndex=r,PPx.Execute("*zoom +0"),PPx.Execute("*delete "+o),linemessage(s.completed)}}else linemessage(s.noEntries)},hasImageView=function(){var e=/(\s|,|)n[\d,]+/,t=PPx.Extract("%*viewstyle");return e.test(t)},getFolderThumbNames=function(){var e=PPx.Extract("%*getcust(S_ppm#user:misc_thumbnames)");return(n+","+e).replace(/;/g,",").split(",")},f=/(%src%|%dst%)/g,createCmdline=function(e,t,r){var n={"%src%":t,"%dst%":r};return e.replace(f,(function(e){return n[e]}))},extractInputData=function(e){var t=[],r=/^[^<]*<([^>]+)>\s*(.+)$/,n=e.replace(r,(function(e,r,n){return t=r.replace(/;/g,",").split(","),n}));return[t,n]};main();
