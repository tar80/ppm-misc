var e=PPx.CreateObject("Scripting.FileSystemObject"),validArgs=function(){for(var e=[],t=PPx.Arguments;!t.atEnd();t.moveNext())e.push(t.value);return e},safeArgs=function(){for(var e=[],t=validArgs(),r=0,n=arguments.length;r<n;r++)e.push(_valueConverter(r<0||arguments.length<=r?undefined:arguments[r],t[r]));return e},_valueConverter=function(e,t){if(null==t||""===t)return null!=e?e:undefined;switch(typeof e){case"number":var r=Number(t);return isNaN(r)?e:r;case"boolean":return"false"!==t&&"0"!==t&&null!=t;default:return t}},t={ppmName:"ppx-plugin-manager",ppmVersion:.95,language:"ja",encode:"utf16le",nlcode:"\r\n",nltype:"crlf",ppmID:"P",ppmSubID:"Q"},useLanguage=function(){var e=PPx.Extract("%*getcust(S_ppm#global:lang)");return"en"===e||"ja"===e?e:t.language},tmp=function(){var e=PPx.Extract('%*extract(C,"%%*temp()")');return{dir:e,file:e+"_ppmtemp",lf:e+"_temp.xlf",stdout:e+"_stdout",stderr:e+"_stderr",ppmDir:function(){var e=PPx.Extract("%'temp'%\\ppm");return PPx.Execute("*makedir "+e),e}}},isEmptyStr=function(e){return""===e},expandNlCode=function(e){var t="\n",r=e.indexOf("\r");return~r&&(t="\r\n"==e.substring(r,r+2)?"\r\n":"\r"),t},isCV8=function(){return"ClearScriptV8"===PPx.ScriptEngineName},r={TypeToCode:{crlf:"\r\n",cr:"\r",lf:"\n"},CodeToType:{"\r\n":"crlf","\r":"cr","\n":"lf"},Ppx:{lf:"%%bl",cr:"%%br",crlf:"%%bn",unix:"%%bl",mac:"%%br",dos:"%%bn","\n":"%%bl","\r":"%%br","\r\n":"%%bn"},Ascii:{lf:"10",cr:"13",crlf:"-1",unix:"10",mac:"13",dos:"-1","\n":"10","\r":"13","\r\n":"-1"}},exec=function(e,t){try{var r;return[!1,null!=(r=t())?r:""]}catch(n){return[!0,""]}finally{e.Close()}},read=function(t){var r=t.path,n=t.enc,a=void 0===n?"utf8":n;if(!e.FileExists(r))return[!0,r+" not found"];var i=e.GetFile(r);if(0===i.Size)return[!0,r+" has no data"];var l=!1,u="";if("utf8"===a){var o=PPx.CreateObject("ADODB.Stream"),c=exec(o,(function(){return o.Open(),o.Charset="UTF-8",o.LoadFromFile(r),o.ReadText(-1)}));l=c[0],u=c[1]}else{var p="utf16le"===a?-1:0,s=i.OpenAsTextStream(1,p),x=exec(s,(function(){return s.ReadAll()}));l=x[0],u=x[1]}return l?[!0,"Unable to read "+r]:[!1,u]},readLines=function(e){var t,r=e.path,n=e.enc,a=void 0===n?"utf8":n,i=e.linefeed,l=read({path:r,enc:a}),u=l[0],o=l[1];if(u)return[!0,o];i=null!=(t=i)?t:expandNlCode(o.slice(0,1e3));var c=o.split(i);return isEmptyStr(c[c.length-1])&&c.pop(),[!1,{lines:c,nl:i}]},writeLines=function(n){var a=n.path,i=n.data,l=n.enc,u=void 0===l?"utf8":l,o=n.append,c=void 0!==o&&o,p=n.overwrite,s=void 0!==p&&p,x=n.linefeed,f=void 0===x?t.nlcode:x;if(!s&&!c&&e.FileExists(a))return[!0,a+" already exists"];var m,P=e.GetParentFolderName(a);if(e.FolderExists(P)||PPx.Execute("*makedir "+P),"utf8"===u){if(isCV8()){var d=i.join(f),h=c?"AppendAllText":"WriteAllText";return[!1,NETAPI.System.IO.File[h](a,d)]}var v=s||c?2:1,E=PPx.CreateObject("ADODB.Stream");m=exec(E,(function(){E.Open(),E.Charset="UTF-8",E.LineSeparator=Number(r.Ascii[f]),c?(E.LoadFromFile(a),E.Position=E.Size,E.SetEOS):E.Position=0,E.WriteText(i.join(f),1),E.SaveToFile(a,v)}))[0]}else{var g=c?8:s?2:1;e.FileExists(a)||PPx.Execute("%Osq *makefile "+a);var b="utf16le"===u?-1:0,S=e.GetFile(a).OpenAsTextStream(g,b);m=exec(S,(function(){S.Write(i.join(f)+f)}))[0]}return m?[!0,"Could not write to "+a]:[!1,""]},n={en:{failedGetPath:"Failed to get path",noSearchWord:"Please specify search word",getHtml:"Getting",upperLimit:"Upper limit",noMatche:"No match"},ja:{failedGetPath:"パスの取得に失敗しました",noSearchWord:"検索単語を指定してください",getHtml:"取得中",upperLimit:"検索上限",noMatche:"一致なし"}},ppx_Discard=function(e,t){var r;PPx.StayMode=0,t=null!=(r=t)?r:"","DEBUG"===e&&PPx.linemessage("[DEBUG] discard "+t)},a={hold:function(e,t){void 0===t&&(t="0");var r=PPx.Extract("%N"),n='KC_main:ACTIVEEVENT,*script ":'+PPx.StayMode+',ppx_Discard",'+t+","+e+"%%:*linecust "+e+"_"+r+",KC_main:ACTIVEEVENT,";PPx.Execute("*linecust "+e+"_"+r+","+n)}},i="M_ppmHelp",l="https://raw.githubusercontent.com/toroidj/toroidj.github.io/master",u="utf8",o="\n",c={words:"ppxwords.html",index:"ppxindex.html",help:"ppxhelp.html",frame:"ppxframe.html"},p=PPx.Extract("%*getcust(S_ppm#user:misc_ppxhp)")||l,s='%*extract("%*getcust(S_ppm#user:misc_browser)") %*getcust(S_ppm#user:misc_helpopt)',x=n[useLanguage()],f=[],main=function(){var t=safeArgs("","",""),r=t[0],n=t[1],i=t[2];!isEmptyStr(r)&&e.FolderExists(r)||(PPx.Echo(x.failedGetPath),PPx.Quit(-1));var l=prepareHelpFiles(r,c),o=l[0],p=l[1];if(o&&(PPx.Echo(p),PPx.Quit(-1)),isEmptyStr(n))return PPx.Execute('%K"@ESC"'),void PPx.Execute("*launch "+s+" "+r+"\\"+c.frame);var m=r+"\\"+c.words,P=readLines({path:m,enc:u}),d=P[0],h=P[1];d&&(PPx.Execute('%K"@ESC"'),PPx.Echo(h),PPx.Quit(-1)),PPx.StayMode=2,f=h.lines,a.hold("misc_help",i),ppx_resume(r,n)},_getHtml=function(t,r){var n=t+"\\"+r;e.FileExists(n)||(PPx.Execute("*linemessage *"+x.getHtml+"* "+r),PPx.Execute('*httpget "'+p+"/"+r+'","'+n+'"'),PPx.Execute("*linemessage"))},prepareHelpFiles=function(t,r){var n=t+"\\"+r.frame;if(!e.FileExists(n)){var a=writeLines({path:n,data:['<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Frameset//EN" "http://www.w3.org/TR/html4/frameset.dtd"><html lang="ja"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>PPx help</title></head>','<frameset cols="20%,*"><frame src="ppxwords.html" name="index"><frame src="ppxhelp.html" name="main"><noframes><body><a href="ppxhelp.html"></a></body></noframes></frameset></html>'],enc:u,linefeed:o,overwrite:!0}),i=a[0],l=a[1];if(i)return[!0,l]}return _getHtml(t,r.words),_getHtml(t,r.index),_getHtml(t,r.help),[!1,""]},m=/^<a href="ppxhelp\.html#(.*)"\starget="main">(.+)<\/a><br>$/,P=/%|<\/?i>|&(quot|amp|lt|gt);/g,d={"%":"%%","<i>":"","</i>":"","&quot;":"","&amp;":"","&lt;":"<","&gt;":">"},ppx_finally=function(){return PPx.Echo("[WARN] instance remain searchHelp.stay.js")},ppx_resume=function(e,r){if(!isEmptyStr(r)){var n=[i+"\t={"],a="file:///"+e.replace(/\\/g,"/")+"/"+c.help,l=9,u=0;do{var o=f[l];if(o.toLowerCase().lastIndexOf(r)>40&&(o.replace(m,(function(e,t,r){r=r.replace(P,(function(e){return d[e]}));var i=String.fromCharCode(u+65);return n.push("&"+i+": "+r+"\t= *launch "+s+" "+a+"#"+t),""})),++u>25)){PPx.linemessage(x.upperLimit);break}l++}while(f[l]);if(0!==u){n.push("}");var p=tmp().file,h=writeLines({path:p,data:n,enc:t.encode,linefeed:t.nlcode,overwrite:!0}),v=h[0],E=h[1];v&&(PPx.Echo(E),PPx.Quit(-1)),PPx.Execute("*setcust @"+p),PPx.Execute("%"+i+",A"),PPx.Execute('*deletecust "M_ppmHelp"'),PPx.Execute("*cursor -5")}else PPx.Execute("*linemessage "+x.noMatche+'%:%K"@^A"')}};main();
